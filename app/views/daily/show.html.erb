<%# Week strip navigation %>
<%= render "shared/week_strip", selected_date: @date, today: Date.current %>

<div class="mb-8">
  <% if @viewing_history %>
    <h1 class="text-3xl font-bold text-stone-800"><%= @date.strftime("%A, %B %-d") %></h1>
    <p class="text-stone-500 mt-1">
      <%= link_to "Back to today", root_path, class: "text-violet-600 hover:text-violet-800 font-medium" %>
    </p>
  <% else %>
    <h1 class="text-3xl font-bold text-stone-800">Hello <%= current_user.name %>,</h1>
    <p class="text-stone-500 mt-1">
      <%= Date.current.strftime("%A, %B %-d") %> &mdash;
      <% today_count = @todos.count { |t| !t.complete? } %>
      <% if today_count > 0 %>
        You have <span class="font-medium text-stone-700"><%= pluralize(today_count, "task") %></span> today
      <% else %>
        No tasks today
      <% end %>
    </p>
  <% end %>
</div>

<% unless @viewing_history %>
  <%# Stat cards %>
  <div class="grid grid-cols-3 gap-4 mb-8">
    <div class="bg-stat-lavender rounded-2xl p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-stat-lavender-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="text-sm font-medium text-stat-lavender-accent">Today</span>
      </div>
      <span class="text-3xl font-bold text-stat-lavender-accent"><%= today_count %></span>
    </div>

    <%= link_to upcoming_path, class: "bg-stat-yellow rounded-2xl p-4 block hover:opacity-90 transition-opacity" do %>
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-stat-yellow-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span class="text-sm font-medium text-stat-yellow-accent">Upcoming</span>
      </div>
      <span class="text-3xl font-bold text-stat-yellow-accent"><%= @upcoming_count %></span>
    <% end %>

    <div class="bg-stat-mint rounded-2xl p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-stat-mint-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <span class="text-sm font-medium text-stat-mint-accent">All</span>
      </div>
      <span class="text-3xl font-bold text-stat-mint-accent"><%= @all_count %></span>
    </div>
  </div>

<% end %>

<%# Tasks heading %>
<div class="flex items-center justify-between mb-3">
  <h2 class="text-sm font-semibold text-stone-500 uppercase tracking-wide">
    <%= @viewing_history ? "Tasks That Day" : "Tasks" %>
  </h2>
  <% unless @viewing_history %>
    <%= link_to new_todo_path(due_date: Date.current), class: "inline-flex items-center gap-1 text-sm font-medium text-violet-600 hover:text-violet-800 transition-colors" do %>
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
      Add task
    <% end %>
  <% end %>
</div>

<% if @todos.any? %>
  <div class="space-y-2">
    <% @todos.each do |todo| %>
      <div class="flex items-center gap-3 bg-white rounded-xl border border-stone-200/60 p-3 shadow-sm <%= @viewing_history ? '' : 'hover:shadow transition-shadow' %>">
        <% if @viewing_history %>
          <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0
            <%= todo.complete? ? 'bg-violet-500 border-violet-500' : 'border-stone-300' %>">
            <% if todo.complete? %>
              <svg class="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            <% end %>
          </div>
        <% else %>
          <%= button_to toggle_todo_path(todo), method: :patch, class: "flex-shrink-0" do %>
            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors
              <%= todo.complete? ? 'bg-violet-500 border-violet-500' : 'border-stone-300 hover:border-violet-400' %>">
              <% if todo.complete? %>
                <svg class="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
              <% end %>
            </div>
          <% end %>
        <% end %>
        <div class="flex-1 min-w-0">
          <span class="<%= todo.complete? ? 'line-through text-stone-400' : 'text-stone-800' %>">
            <%= todo.title %>
          </span>
          <% if todo.project %>
            <span class="inline-flex items-center text-xs bg-stone-100 text-stone-500 rounded-full px-2 py-0.5 ml-2"><%= [todo.project.emoji, todo.project.title].compact.join(" ") %></span>
          <% end %>
        </div>
        <% if todo.project && todo.project.members.any? %>
          <% todo_members = ([todo.project.user] + todo.project.members.to_a).uniq %>
          <%= avatar_stack(todo_members, size: :xs, max: 3) %>
        <% end %>
        <% if @viewing_history && todo.complete? && todo.due_date && todo.due_date != @date %>
          <span class="text-xs text-stone-400 flex-shrink-0">due <%= todo.due_date.strftime("%b %-d") %></span>
        <% elsif !@viewing_history && todo.due_date %>
          <span class="text-xs text-stone-400 flex-shrink-0"><%= todo.due_date.strftime("%b %-d") %></span>
        <% end %>
        <% unless @viewing_history %>
          <%= link_to "Edit", edit_todo_path(todo), class: "text-xs text-stone-400 hover:text-stone-600 transition-colors flex-shrink-0" %>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <%= render "shared/empty_state", message: @viewing_history ? "No tasks were recorded for this day." : "Nothing on the list for today. Enjoy your day!" %>
<% end %>

<%= render "notes/notes", notable: @daily_page %>

<% unless @viewing_history %>
  <%# Activity graph %>
  <div class="mt-8">
    <h2 class="text-sm font-semibold text-stone-500 uppercase tracking-wide mb-3">Activity</h2>
    <div class="bg-white rounded-2xl p-5 shadow-sm">
      <%= render "shared/contribution_graph", record: current_user %>
    </div>
  </div>
<% end %>
