<% pastel_cards = %w[bg-card-1 bg-card-2 bg-card-3 bg-card-4 bg-card-5 bg-card-6] %>
<% card_texts = %w[text-card-text-1 text-card-text-2 text-card-text-3 text-card-text-4 text-card-text-5 text-card-text-6] %>

<div class="flex items-center justify-between mb-8">
  <h1 class="text-3xl font-bold text-stone-800">Goals</h1>
  <%= link_to "New goal", new_goal_path, class: "inline-flex items-center gap-1 bg-violet-600 text-white rounded-xl px-4 py-2 text-sm font-medium hover:bg-violet-700 transition-colors" %>
</div>

<% if @goals.any? %>
  <div class="relative">
    <% @goals.each_with_index do |goal, i| %>
      <% card_bg = pastel_cards[i % pastel_cards.length] %>
      <% card_text = card_texts[i % card_texts.length] %>
      <%= link_to goal_path(goal), class: "group block #{card_bg} rounded-2xl p-5 shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-1 #{i > 0 ? '-mt-3' : ''} relative", style: "z-index: #{i + 1}" do %>
        <div class="flex items-center justify-between">
          <div class="flex-1 min-w-0">
            <h2 class="font-bold text-lg text-stone-800"><%= [goal.emoji, goal.title].compact.join(" ") %></h2>
            <div class="flex items-center gap-2 mt-1">
              <% if goal.notes.any? %>
                <span class="text-xs bg-white/50 rounded-full px-2 py-0.5 text-stone-600"><%= pluralize(goal.notes.count, "note") %></span>
              <% end %>
              <% completed = goal.todos.where.not(completed_at: nil).count %>
              <% if completed > 0 %>
                <span class="text-xs bg-white/50 rounded-full px-2 py-0.5 text-stone-600"><%= completed %> done</span>
              <% end %>
              <span class="text-xs px-2 py-0.5 rounded-full <%= goal.active? ? 'bg-white/60 text-emerald-700' : 'bg-white/40 text-stone-500' %>">
                <%= goal.status.capitalize %>
              </span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <% goal_members = ([goal.user] + goal.members.to_a).uniq %>
            <% if goal_members.size > 1 %>
              <%= avatar_stack(goal_members, size: :xs, max: 3) %>
            <% end %>
            <div class="hidden sm:block">
              <%= render "shared/momentum", record: goal %>
            </div>
            <svg class="w-5 h-5 text-stone-400 group-hover:text-stone-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </div>

        <%# Expand on hover %>
        <div class="max-h-0 overflow-hidden group-hover:max-h-40 transition-all duration-300 ease-in-out">
          <div class="pt-3 mt-3 border-t border-white/40">
            <% if goal.description.present? %>
              <p class="text-sm text-stone-600 mb-2"><%= truncate(goal.description, length: 120) %></p>
            <% end %>
            <div class="flex items-center justify-between mt-1">
              <span class="text-xs text-stone-500"><%= pluralize(goal.projects.count, "project") %></span>
              <%= render "shared/sparkline", record: goal %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
<% else %>
  <%= render "shared/empty_state", message: "No goals yet. Create one to get started." %>
<% end %>
